
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lazyft.hyperopt.runner &#8212; LazyFT 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pyramid.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.hyperopt.runner</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lazyft.hyperopt.runner</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rapidjson</span>
<span class="kn">import</span> <span class="nn">sh</span>
<span class="kn">from</span> <span class="nn">rich.live</span> <span class="kn">import</span> <span class="n">Live</span>
<span class="kn">from</span> <span class="nn">rich.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="kn">from</span> <span class="nn">lazyft</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">downloader</span><span class="p">,</span>
    <span class="n">hyperopt</span><span class="p">,</span>
    <span class="n">logger</span><span class="p">,</span>
    <span class="n">parameter_tools</span><span class="p">,</span>
    <span class="n">paths</span><span class="p">,</span>
    <span class="n">runner</span><span class="p">,</span>
    <span class="n">strategy</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">lazyft.database</span> <span class="kn">import</span> <span class="n">engine</span>
<span class="kn">from</span> <span class="nn">lazyft.models.hyperopt</span> <span class="kn">import</span> <span class="n">HyperoptReport</span>
<span class="kn">from</span> <span class="nn">lazyft.notify</span> <span class="kn">import</span> <span class="n">notify_telegram</span>
<span class="kn">from</span> <span class="nn">lazyft.reports</span> <span class="kn">import</span> <span class="n">get_hyperopt_repo</span>
<span class="kn">from</span> <span class="nn">lazyft.space_handler</span> <span class="kn">import</span> <span class="n">SpaceHandler</span>
<span class="kn">from</span> <span class="nn">lazyft.util</span> <span class="kn">import</span> <span class="n">get_last_hyperopt_file_name</span>

<span class="n">EPOCH_LINE_REGEX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;epoch&gt;[\d/]+)[\s|]+(?P&lt;trades&gt;[\d/]+)[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;wins_draws_losses&gt;\d+\s+\d+\s+\d+)[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;average_profit&gt;[\d.-]+%)[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;profit&gt;[\d.-]+ \w+\s+\([\d.,-]+%\))[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;average_duration&gt;\d+ \w+ [\d:]+)[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;max_drawdown&gt;(?:[\d.-]+ (\w+\s+)\([\d.]+%\))?(?:--)?)[\s|]+&#39;</span>
    <span class="sa">r</span><span class="s1">&#39;(?P&lt;objective&gt;[\d.,-]+)&#39;</span>
<span class="p">)</span>
<span class="n">logger_exec</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;hyperopt&#39;</span><span class="p">)</span>
<span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Epoch&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Trades&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Win Draw Loss&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Avg profit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Profit&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Avg duration&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Max Drawdown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Objective&quot;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="HyperoptManager"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptManager">[docs]</a><span class="k">class</span> <span class="nc">HyperoptManager</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">hyperopt</span><span class="o">.</span><span class="n">HyperoptCommand</span><span class="p">],</span> <span class="n">autosave</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs multiple instances of HyperoptRunner sequentially.</span>

<span class="sd">        :param commands: A list of HyperoptCommand objects that will be passed to the runner.</span>
<span class="sd">        :param autosave: If True, the results will be saved to the database on completion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span> <span class="o">=</span> <span class="n">autosave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HyperoptReport</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HyperoptRunner</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HyperoptRunner</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failed_runners</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">HyperoptRunner</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">HyperoptRunner</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">autosave</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">HyperoptRunner</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>

<div class="viewcode-block" id="HyperoptManager.execute"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptManager.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the hyperopt commands in a non-blocking way.</span>

<span class="sd">        :return: The thread object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hyperopting in the background&#39;</span><span class="p">)</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_runner</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">thread</span>
        <span class="k">return</span> <span class="n">thread</span></div>

    <span class="k">def</span> <span class="nf">_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs each HyperoptRunner found in the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_flag</span><span class="p">:</span>
            <span class="n">r</span><span class="p">:</span> <span class="n">HyperoptRunner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span> <span class="o">=</span> <span class="n">r</span>
            <span class="c1"># noinspection PyBroadException</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">on_finished</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">notify_telegram</span><span class="p">(</span><span class="s1">&#39;Hyperopt Manager&#39;</span><span class="p">,</span> <span class="s1">&#39;Finished hyperopting&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="HyperoptManager.on_finished"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptManager.on_finished">[docs]</a>    <span class="k">def</span> <span class="nf">on_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runner</span><span class="p">:</span> <span class="s1">&#39;HyperoptRunner&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when a runner finishes.</span>

<span class="sd">        :param runner: The runner that finished.</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">runner</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Failed while hyperopting </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">300</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">failed_runners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Hyperopt finished </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">:</span>
                <span class="n">runner</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

<div class="viewcode-block" id="HyperoptManager.stop"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptManager.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops the hyperopt manager and clears the queue.</span>

<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear queue</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div></div>

    <span class="c1"># def generate_reports(self):</span>
    <span class="c1">#     for r in self.runners:</span>
    <span class="c1">#         sh.freqtrade(&#39;hyperopt-show --best&#39;.split())</span>
    <span class="c1">#         report = r.generate_report()</span>
    <span class="c1">#         report.save()</span>
    <span class="c1">#         self.reports.append(report)</span>


<div class="viewcode-block" id="HyperoptRunner"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner">[docs]</a><span class="k">class</span> <span class="nc">HyperoptRunner</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">Runner</span><span class="p">):</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">command</span><span class="p">:</span> <span class="n">hyperopt</span><span class="o">.</span><span class="n">HyperoptCommand</span><span class="p">,</span>
        <span class="n">autosave</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">notify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a single instance of HyperoptRunner.</span>

<span class="sd">        :param command: A HyperoptCommand object.</span>
<span class="sd">        :param autosave: If True, the results will be saved to the database on completion.</span>
<span class="sd">        :param notify: If True, a notification will be sent on finish.</span>
<span class="sd">        :param verbose: If True, more output will be printed to the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">command</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">notify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span> <span class="o">=</span> <span class="n">autosave</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">logfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epoch_text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_result_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HyperoptReport</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path to the log file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">paths</span><span class="o">.</span><span class="n">HYPEROPT_LOG_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_id</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>

<div class="viewcode-block" id="HyperoptRunner.pre_execute"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.pre_execute">[docs]</a>    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_strategy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the HyperoptRunner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">HyperoptRunner</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Hyperopt is already running&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Preparing to hyperopt </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">download_data</span><span class="p">:</span>
            <span class="n">downloader</span><span class="o">.</span><span class="n">download_data_for_strategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># set or remove parameter file in strategy directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">get_hyperopt_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Hyperopt id </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> does not match strategy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">parameter_tools</span><span class="o">.</span><span class="n">set_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parameter_tools</span><span class="o">.</span><span class="n">remove_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">load_strategy</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strategy_hash</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">save_strategy_text_to_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check to see if the report with hyperopt id has a strategy hash</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">get_hyperopt_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_backup_strategy</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="c1"># update spaces file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_spaces</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_spaces</span><span class="p">()</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running command: &quot;freqtrade </span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger_exec</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running command: &quot;freqtrade </span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Hyperopting </span><span class="si">{}</span><span class="s1"> with id &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">hyperopt_id</span> <span class="ow">or</span> <span class="s1">&#39;NO_ID&#39;</span>
        <span class="p">)</span>

        <span class="n">HyperoptRunner</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span></div>

<div class="viewcode-block" id="HyperoptRunner.execute"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">load_strategy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the Hyperopt command.</span>

<span class="sd">        :param background: If True, the command will be executed in the background.</span>
<span class="sd">        :param load_strategy: If True, the strategy will be loaded from the database using the</span>
<span class="sd">                hyperopt ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># validate run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">(</span><span class="n">load_strategy</span><span class="p">)</span>

        <span class="c1"># Execute VIA sh</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executing Hyperopt&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="n">freqtrade</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">),</span>
                <span class="n">no_color</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">_out</span><span class="o">=</span><span class="k">lambda</span> <span class="n">log</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_process_log</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">_err</span><span class="o">=</span><span class="k">lambda</span> <span class="n">log</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_process_log</span><span class="p">(</span><span class="n">log</span><span class="p">),</span>
                <span class="n">_cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">BASE_DIR</span><span class="p">),</span>
                <span class="n">_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">_done</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_finished</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">background</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process ID: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">200</span><span class="p">:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">background</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="HyperoptRunner.stop"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span></div>

<div class="viewcode-block" id="HyperoptRunner.join"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperoptRunner.live_output"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.live_output">[docs]</a>    <span class="k">def</span> <span class="nf">live_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use rich lib to display an updatable table with epoch information&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">_Printer</span><span class="o">.</span><span class="n">create_new_table</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">Live</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">refresh_per_second</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">console</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="p">)</span> <span class="k">as</span> <span class="n">live</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.4</span><span class="p">)</span>
                    <span class="n">live</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_results_as_table</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_list</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]))</span></div>

    <span class="k">def</span> <span class="nf">_get_results_as_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generates tables for live_output&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">EPOCH_LINE_REGEX</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">_Printer</span><span class="o">.</span><span class="n">create_new_table</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">add_row</span><span class="p">(</span><span class="o">*</span><span class="n">d</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">table</span>

<div class="viewcode-block" id="HyperoptRunner.on_finished"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.on_finished">[docs]</a>    <span class="k">def</span> <span class="nf">on_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">_2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The callback for the sh command in execute()&quot;&quot;&quot;</span>
        <span class="n">HyperoptRunner</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parameter_tools</span><span class="o">.</span><span class="n">remove_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Finished with errors&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="p">:</span>
                    <span class="n">notify_telegram</span><span class="p">(</span>
                        <span class="s1">&#39;Hyperopt Runner - Hyperopt Failed&#39;</span><span class="p">,</span> <span class="s1">&#39;Hyperopt finished with errors&#39;</span>
                    <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s2">&quot;Finished successfully.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">manually_stopped</span><span class="p">:</span>
                    <span class="n">notify_telegram</span><span class="p">(</span>
                        <span class="s1">&#39;Hyperopt Runner - Hyperopt Finished&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;Hyperopt finished successfully. Elapsed time: </span><span class="si">%s</span><span class="s1">minutes &#39;</span>
                        <span class="o">%</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">//</span> <span class="mi">60</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Report generated&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">autosave</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Auto-saved: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">strategy</span><span class="o">.</span><span class="n">delete_temporary_strategy_backup_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_strategy_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_worker</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="HyperoptRunner.save"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HyperoptReport</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the the hyperopt result to the database.</span>

<span class="sd">        :param epoch: An optional epoch to save. If None, the best epoch is used. This epoch will</span>
<span class="sd">                      have 1 subtracted from it.</span>
<span class="sd">        :param tag: An optional tag to save.</span>
<span class="sd">        :return: The saved report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No report available&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report</span>
            <span class="k">if</span> <span class="n">epoch</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">new_report_from_epoch</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
                <span class="n">report</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created report id: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">HYPEROPT_LOG_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span> <span class="o">=</span> <span class="n">report</span>
        <span class="k">return</span> <span class="n">report</span></div>

<div class="viewcode-block" id="HyperoptRunner.get_epoch_report"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.get_epoch_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_epoch_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HyperoptReport</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the report for a specific epoch.</span>

<span class="sd">        :param epoch: The epoch to get the report for.</span>
<span class="sd">        :return: The report for the epoch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">hyperopt_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">LAST_HYPEROPT_RESULTS_FILE</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span>
            <span class="n">rapidjson</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">LAST_HYPEROPT_RESULTS_FILE</span><span class="o">.</span><span class="n">read_text</span><span class="p">())[</span><span class="s1">&#39;latest_hyperopt&#39;</span><span class="p">],</span>
        <span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">HyperoptReport</span><span class="p">(</span>
            <span class="n">hyperopt_file_str</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">hyperopt_file</span><span class="p">),</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">epoch</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">report</span></div>

<div class="viewcode-block" id="HyperoptRunner.generate_report"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.generate_report">[docs]</a>    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a report that can saved later on.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span> <span class="o">=</span> <span class="n">HyperoptReport</span><span class="o">.</span><span class="n">from_hyperopt_result</span><span class="p">(</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">HYPEROPT_RESULTS_DIR</span> <span class="o">/</span> <span class="n">get_last_hyperopt_file_name</span><span class="p">(),</span>
            <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="o">.</span><span class="n">epoch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="o">.</span><span class="n">get_best_epoch</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="o">.</span><span class="n">strategy_hash</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_report</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tag</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_report</span></div>

<div class="viewcode-block" id="HyperoptRunner.get_results"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.get_results">[docs]</a>    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Scrapes the hyperopt epoch information using regex and returns a DataFrame&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">EPOCH_LINE_REGEX</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperoptRunner.sub_process_log"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.sub_process_log">[docs]</a>    <span class="k">def</span> <span class="nf">sub_process_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For logging purposes. Fills the write_queue&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span> <span class="ow">or</span> <span class="s2">&quot;ETA&quot;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">logger_exec</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">console</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></div>

<div class="viewcode-block" id="HyperoptRunner.update_spaces"><a class="viewcode-back" href="../../../lazyft.hyperopt.html#lazyft.hyperopt.runner.HyperoptRunner.update_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">update_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating custom spaces...&#39;</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">SpaceHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">strategy_path</span> <span class="o">/</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">))</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_spaces</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Enabling all custom spaces&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">set_all_enabled</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">space</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_spaces</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Enabling space: </span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">add_space</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting space-setting: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">add_setting</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div></div>


<span class="k">class</span> <span class="nc">_Printer</span><span class="p">:</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_new_table</span><span class="p">():</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="o">*</span><span class="n">columns</span><span class="p">,</span>
            <span class="n">show_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">header_style</span><span class="o">=</span><span class="s2">&quot;bold magenta&quot;</span><span class="p">,</span>
            <span class="n">show_lines</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">expand</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.hyperopt.runner</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Raphael.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.0.
    </div>
  </body>
</html>