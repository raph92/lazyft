
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lazyft.downloader &#8212; LazyFT 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.downloader</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lazyft.downloader</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">queue</span> <span class="kn">import</span> <span class="n">Empty</span><span class="p">,</span> <span class="n">Queue</span>
<span class="kn">from</span> <span class="nn">threading</span> <span class="kn">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">alive_progress</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">sh</span>
<span class="kn">from</span> <span class="nn">freqtrade.data.history</span> <span class="kn">import</span> <span class="n">load_pair_history</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">lazyft</span> <span class="kn">import</span> <span class="n">logger</span><span class="p">,</span> <span class="n">paths</span>
<span class="kn">from</span> <span class="nn">lazyft.command_parameters</span> <span class="kn">import</span> <span class="n">BacktestParameters</span><span class="p">,</span> <span class="n">HyperoptParameters</span>
<span class="kn">from</span> <span class="nn">lazyft.config</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">lazyft.paths</span> <span class="kn">import</span> <span class="n">USER_DATA_DIR</span>
<span class="kn">from</span> <span class="nn">lazyft.strategy</span> <span class="kn">import</span> <span class="n">load_informative_intervals_and_pairs_from_strategy</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">utc</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">UTC</span>

<span class="n">exec_log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;general&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="DownloadRecord"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.DownloadRecord">[docs]</a><span class="k">class</span> <span class="nc">DownloadRecord</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The DownloadRecord class is a model that defines the data to be stored in the database</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requested_start_date</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">actual_start_date</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reached_first_candle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True if the last requested start date is the before or the same day as the actual</span>
<span class="sd">        start date.</span>
<span class="sd">        If this is True then the beginning of the pairs candle lifetime has been reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">requested_start_date</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual_start_date</span></div>


<div class="viewcode-block" id="History"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.History">[docs]</a><span class="k">class</span> <span class="nc">History</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A convenience class to for storing/retrieving the history of a pair.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">history</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DownloadRecord</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span></div>


<div class="viewcode-block" id="load_history"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.load_history">[docs]</a><span class="k">def</span> <span class="nf">load_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">History</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the download history from the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">history_file</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">history_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">history_file</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">history_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">History</span><span class="o">.</span><span class="n">parse_file</span><span class="p">(</span><span class="n">history_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load history file </span><span class="si">{</span><span class="n">history_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="save_record"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.save_record">[docs]</a><span class="k">def</span> <span class="nf">save_record</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">DownloadRecord</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It takes a pair, a record, an exchange, and an interval, and saves the record to the history file</span>

<span class="sd">    :param pair: The pair to save the record for</span>
<span class="sd">    :type pair: str</span>
<span class="sd">    :param record: The DownloadRecord object that was created by the download function</span>
<span class="sd">    :type record: DownloadRecord</span>
<span class="sd">    :param exchange: The name of the exchange</span>
<span class="sd">    :type exchange: str</span>
<span class="sd">    :param interval: The interval of the data</span>
<span class="sd">    :type interval: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">load_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">=</span> <span class="n">record</span>
    <span class="n">history_file</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
    <span class="n">history_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">json</span><span class="p">())</span></div>


<div class="viewcode-block" id="delete_record"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.delete_record">[docs]</a><span class="k">def</span> <span class="nf">delete_record</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the pair record from the download history.</span>

<span class="sd">    :param pair: pair to remove</span>
<span class="sd">    :param exchange: exchange to remove</span>
<span class="sd">    :param interval: interval to remove</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">history</span> <span class="o">=</span> <span class="n">load_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">history_file</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)</span>
    <span class="n">history_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">json</span><span class="p">())</span></div>


<div class="viewcode-block" id="get_pair_time_range"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.get_pair_time_range">[docs]</a><span class="k">def</span> <span class="nf">get_pair_time_range</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It loads the data for the specified pair and interval from the specified exchange</span>

<span class="sd">    :param pair: The pair to get the time range for</span>
<span class="sd">    :type pair: str</span>
<span class="sd">    :param interval: The time interval between each data point</span>
<span class="sd">    :type interval: str</span>
<span class="sd">    :param exchange: The exchange to get the historical data for</span>
<span class="sd">    :type exchange: str</span>
<span class="sd">    :return: A tuple of two datetime objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting time range for </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">load_pair_history</span><span class="p">(</span>
        <span class="n">pair</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">,</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">USER_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">exchange</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No data found for </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> on </span><span class="si">{</span><span class="n">exchange</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">end_date</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span></div>


<div class="viewcode-block" id="update_download_history"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.update_download_history">[docs]</a><span class="k">def</span> <span class="nf">update_download_history</span><span class="p">(</span>
    <span class="n">requested_start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">intervals</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the download history with the actual start date.</span>

<span class="sd">    :param requested_start_date: requested start date</span>
<span class="sd">    :param pairs: list of pairs</span>
<span class="sd">    :param intervals: a list of intervals e.g. [&#39;1m&#39;, &#39;5m&#39;]</span>
<span class="sd">    :param exchange: exchange</span>
<span class="sd">    :return: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">get_pair_time_range</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">exchange</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">start_date</span><span class="p">:</span>
                <span class="n">delete_record</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to load dates for pair </span><span class="si">{}</span><span class="s2"> @ interval </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">pair</span><span class="p">,</span> <span class="n">interval</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">pairs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">DownloadRecord</span><span class="p">(</span>
                <span class="n">requested_start_date</span><span class="o">=</span><span class="n">requested_start_date</span><span class="p">,</span>
                <span class="n">actual_start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">save_record</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Download history updated for </span><span class="si">{</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="si">}</span><span class="s1"> @ </span><span class="si">{</span><span class="n">intervals</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="remove_pair_record"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.remove_pair_record">[docs]</a><span class="k">def</span> <span class="nf">remove_pair_record</span><span class="p">(</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">HyperoptParameters</span><span class="p">,</span> <span class="n">BacktestParameters</span><span class="p">]</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the pair record from the download history.</span>

<span class="sd">    :param pair: pair to remove</span>
<span class="sd">    :param strategy: strategy to remove</span>
<span class="sd">    :param params: HyperoptParameters or BacktestParameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intervals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">load_informative_intervals_and_pairs_from_strategy</span><span class="p">(</span>
        <span class="n">params</span><span class="o">.</span><span class="n">to_config_dict</span><span class="p">(</span><span class="n">strategy</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">timeframe_detail</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="n">delete_record</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_if_download_is_needed"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.check_if_download_is_needed">[docs]</a><span class="k">def</span> <span class="nf">check_if_download_is_needed</span><span class="p">(</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">requested_start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">requested_end_date</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the pair is already downloaded.</span>

<span class="sd">    :param exchange: Exchange name</span>
<span class="sd">    :param pair: Pair name. Example: BTC/USDT</span>
<span class="sd">    :param interval: Interval name</span>
<span class="sd">    :param requested_start_date: Start date of the download</span>
<span class="sd">    :param requested_end_date: End date of the download</span>
<span class="sd">    :return: True if the pair needs to be downloaded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># first check if pair file exists for the requested interval</span>
    <span class="c1"># example of pairfile: BTC_USDT-1m.json.</span>
    <span class="c1"># The forward slash is needs to be replaced with an underscore</span>
    <span class="n">pair_file</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">PAIR_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span>
        <span class="n">exchange</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">pair</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s1">.json&#39;</span>
    <span class="p">)</span>
    <span class="n">need_pair_file</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">pair_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="c1"># replace all dates with UTC</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking if download is needed for </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Check if the pair is already downloaded</span>
    <span class="n">download_history</span> <span class="o">=</span> <span class="n">load_history</span><span class="p">(</span><span class="n">exchange</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span><span class="o">.</span><span class="n">history</span>
    <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">download_history</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Pair not in download history. Downloading.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download history for </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">download_history</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">download_record</span> <span class="o">=</span> <span class="n">download_history</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>

    <span class="c1"># check if the pair has reached the first candle</span>
    <span class="n">needs_beginning_candles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">requested_start_date</span> <span class="o">&lt;</span> <span class="n">download_record</span><span class="o">.</span><span class="n">actual_start_date</span>
        <span class="ow">and</span> <span class="ow">not</span> <span class="n">download_record</span><span class="o">.</span><span class="n">reached_first_candle</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> needs beginning candles: </span><span class="si">{</span><span class="n">needs_beginning_candles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># make sure the difference between the requested end date and the actual end date is less than max_end_gap</span>
    <span class="c1"># if the requested end date is None, then we don&#39;t care about the end date</span>

    <span class="n">max_end_gap</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">requested_end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">needs_end_candles</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">requested_end_date</span> <span class="o">&gt;</span> <span class="n">download_record</span><span class="o">.</span><span class="n">end_date</span>
            <span class="ow">and</span> <span class="n">requested_end_date</span> <span class="o">-</span> <span class="n">download_record</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;</span> <span class="n">max_end_gap</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needs_end_candles</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> needs end candles: </span><span class="si">{</span><span class="n">needs_end_candles</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">need_pair_file</span> <span class="ow">or</span> <span class="n">needs_beginning_candles</span> <span class="ow">or</span> <span class="n">needs_end_candles</span></div>


<div class="viewcode-block" id="download_data_for_strategy"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_data_for_strategy">[docs]</a><span class="k">def</span> <span class="nf">download_data_for_strategy</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BacktestParameters</span><span class="p">,</span> <span class="n">HyperoptParameters</span><span class="p">],</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It downloads the data for the given strategy, if it&#39;s not already downloaded</span>

<span class="sd">    :param strategy: The strategy to download data for</span>
<span class="sd">    :type strategy: str</span>
<span class="sd">    :param config: Config</span>
<span class="sd">    :type config: Config</span>
<span class="sd">    :param parameters: Union[BacktestParameters, HyperoptParameters]</span>
<span class="sd">    :type parameters: Union[BacktestParameters, HyperoptParameters]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intervals</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">load_informative_intervals_and_pairs_from_strategy</span><span class="p">(</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">to_config_dict</span><span class="p">(</span><span class="n">strategy</span><span class="p">),</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">timeframe_detail</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">download_missing_historical_data</span><span class="p">(</span>
        <span class="n">config</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">+</span> <span class="n">parameters</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">timerange</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="download_data_with_parameters"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_data_with_parameters">[docs]</a><span class="k">def</span> <span class="nf">download_data_with_parameters</span><span class="p">(</span>
    <span class="n">strategy</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">BacktestParameters</span><span class="p">,</span> <span class="n">HyperoptParameters</span><span class="p">],</span>
<span class="p">):</span>
    <span class="n">intervals</span><span class="p">,</span> <span class="n">pairs</span> <span class="o">=</span> <span class="n">load_informative_intervals_and_pairs_from_strategy</span><span class="p">(</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">to_config_dict</span><span class="p">(</span><span class="n">strategy</span><span class="p">),</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">timeframe_detail</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">download_missing_historical_data</span><span class="p">(</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">parameters</span><span class="o">.</span><span class="n">timerange</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="download_data_with_config"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_data_with_config">[docs]</a><span class="k">def</span> <span class="nf">download_data_with_config</span><span class="p">(</span>
    <span class="n">lft_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">timerange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">loaded_intervals</span><span class="p">,</span> <span class="n">loaded_pairs</span> <span class="o">=</span> <span class="n">load_informative_intervals_and_pairs_from_strategy</span><span class="p">(</span>
        <span class="n">lft_config</span><span class="p">,</span>
        <span class="n">lft_config</span><span class="p">[</span><span class="s2">&quot;pairs&quot;</span><span class="p">],</span>
        <span class="n">lft_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeframe_detail&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">download_missing_historical_data</span><span class="p">(</span>
        <span class="n">lft_config</span><span class="p">,</span> <span class="n">loaded_intervals</span><span class="p">,</span> <span class="n">loaded_pairs</span><span class="p">,</span> <span class="n">timerange</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="download_missing_historical_data"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_missing_historical_data">[docs]</a><span class="k">def</span> <span class="nf">download_missing_historical_data</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
    <span class="n">intervals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">timerange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It checks if the data is already downloaded for the given</span>
<span class="sd">    pairs and intervals. If not, it downloads the data</span>

<span class="sd">    :param intervals: list of intervals to download</span>
<span class="sd">    :param pairs: list of pairs to download</span>
<span class="sd">    :param config: Config object</span>
<span class="sd">    :param timerange: timerange to download</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">timerange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">end_date</span><span class="p">:</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">end_date</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">utc</span><span class="p">)</span>
    <span class="n">pairs_to_download</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">tf_to_download</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">pair_list</span> <span class="o">=</span> <span class="n">pairs</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Checking if download is needed for &quot;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pair_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> @ &#39;</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span><span class="si">}</span><span class="s1"> interval(s)&#39;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pair_list</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">check_if_download_is_needed</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span>
            <span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Download needed for </span><span class="si">{</span><span class="n">pair</span><span class="si">}</span><span class="s2"> @ </span><span class="si">{</span><span class="n">interval</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">pairs_to_download</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
                <span class="n">tf_to_download</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pairs_to_download</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloading missing data for </span><span class="si">{</span><span class="n">pairs_to_download</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># create datetime string in the YYYYMMDD format from the start date</span>
        <span class="n">start_date_str</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">-&quot;</span><span class="p">)</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">download_watcher</span><span class="p">,</span>
            <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                <span class="n">queue</span><span class="p">,</span>
                <span class="n">start_date</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">pairs_to_download</span><span class="p">),</span>
                <span class="n">tf_to_download</span><span class="p">,</span>
                <span class="n">config</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">download</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tf_to_download</span><span class="p">),</span>
            <span class="n">pairs</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">pairs_to_download</span><span class="p">),</span>
            <span class="n">timerange</span><span class="o">=</span><span class="n">start_date_str</span><span class="p">,</span>
            <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Finished downloading data for </span><span class="si">{}</span><span class="s2"> pairs @ </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">pairs_to_download</span><span class="p">),</span>
            <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tf_to_download</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Data is up to date&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="download"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download">[docs]</a><span class="k">def</span> <span class="nf">download</span><span class="p">(</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Config</span><span class="p">,</span>
    <span class="n">interval</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">days</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">pairs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">timerange</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">secrets_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">queue</span><span class="p">:</span> <span class="n">Queue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        config: A config file object</span>
<span class="sd">        pairs: A list of pairs</span>
<span class="sd">        interval: The ticker interval. Default: 5m</span>
<span class="sd">        days: How many days worth of data to download</span>
<span class="sd">        timerange: Optional timerange parameter</span>
<span class="sd">        secrets_config: Optional secrets config file</span>
<span class="sd">        queue: Optional queue to put the data into</span>

<span class="sd">    Returns: A queue that takes in output from the downloader</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">days</span> <span class="ow">or</span> <span class="n">timerange</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pairs</span><span class="p">:</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">whitelist</span>
    <span class="k">if</span> <span class="n">timerange</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">timerange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
        <span class="n">days_between</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_dt</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
        <span class="n">days</span> <span class="o">=</span> <span class="n">days_between</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Downloading </span><span class="si">{}</span><span class="s2"> days worth of market data for </span><span class="si">{}</span><span class="s2"> @ </span><span class="si">{}</span><span class="s2"> ticker-interval(s)...&quot;</span><span class="p">,</span>
        <span class="n">days</span><span class="p">,</span>
        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span>
        <span class="n">interval</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;download-data --days </span><span class="si">{}</span><span class="s2"> -c </span><span class="si">{}</span><span class="s2"> -p </span><span class="si">{}</span><span class="s2"> -t </span><span class="si">{}</span><span class="s2"> --userdir </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">days</span><span class="p">,</span>
        <span class="n">config</span><span class="p">,</span>
        <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pairs</span><span class="p">),</span>
        <span class="n">interval</span><span class="p">,</span>
        <span class="n">USER_DATA_DIR</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;-c </span><span class="si">{</span><span class="n">secrets_config</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">secrets_config</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">sh</span><span class="o">.</span><span class="n">freqtrade</span><span class="p">(</span>
        <span class="o">*</span><span class="n">command</span><span class="p">,</span>
        <span class="n">_err</span><span class="o">=</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span> <span class="k">if</span> <span class="n">queue</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">_out</span><span class="o">=</span><span class="n">queue</span><span class="o">.</span><span class="n">put</span> <span class="k">if</span> <span class="n">queue</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="download_pair"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_pair">[docs]</a><span class="k">def</span> <span class="nf">download_pair</span><span class="p">(</span><span class="n">pair</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intervals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">timerange</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It downloads the data for the specified pair, exchange, and intervals</span>

<span class="sd">    :param pair: The pair to download</span>
<span class="sd">    :type pair: str</span>
<span class="sd">    :param exchange: The exchange you want to download from</span>
<span class="sd">    :type exchange: str</span>
<span class="sd">    :param intervals: A list of intervals to download</span>
<span class="sd">    :type intervals: list[str]</span>
<span class="sd">    :param timerange: The time range to download data for</span>
<span class="sd">    :type timerange: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">exchange</span> <span class="o">+</span> <span class="s2">&quot;.json&quot;</span><span class="p">)</span>
    <span class="n">download_missing_historical_data</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="p">[</span><span class="n">pair</span><span class="p">],</span> <span class="n">timerange</span><span class="p">)</span></div>


<div class="viewcode-block" id="download_watcher"><a class="viewcode-back" href="../../lazyft.html#lazyft.downloader.download_watcher">[docs]</a><span class="k">def</span> <span class="nf">download_watcher</span><span class="p">(</span>
    <span class="n">queue</span><span class="p">:</span> <span class="n">Queue</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">:</span> <span class="n">datetime</span><span class="p">,</span>
    <span class="n">n_pairs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">timeframes</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">exchange</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    It iterates over the number of pairs,</span>
<span class="sd">    and downloads the data for each pair. It then updates the download history</span>

<span class="sd">    :param queue: Queue to put the output into</span>
<span class="sd">    :param start_date: The start date to download data for</span>
<span class="sd">    :param n_pairs: The number of pairs to download</span>
<span class="sd">    :param timeframes: The timeframes to download</span>
<span class="sd">    :param exchange: The exchange to download from</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pair_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">timeframe_idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">alive_progress</span><span class="o">.</span><span class="n">alive_bar</span><span class="p">(</span>
        <span class="n">n_pairs</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Downloading pair data&quot;</span><span class="p">,</span> <span class="n">force_tty</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">pair_idx</span> <span class="o">&lt;</span> <span class="n">n_pairs</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Empty</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Downloader is not responding. Aborting.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="n">exec_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">if</span> <span class="s2">&quot;Closing async ccxt session&quot;</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="s2">&quot;Downloaded data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">timeframe_idx</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1"># Downloaded data for AVAX/USDT with length 1877</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;Downloaded data for &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; with length &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">timeframe_idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeframes</span><span class="p">):</span>
                <span class="n">update_download_history</span><span class="p">(</span>
                    <span class="n">start_date</span><span class="p">,</span> <span class="p">[</span><span class="n">pair</span><span class="p">],</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeframes</span><span class="p">),</span> <span class="n">exchange</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Downloaded history for </span><span class="si">{}</span><span class="s2"> @ </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">pair</span><span class="p">,</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeframes</span><span class="p">),</span>
                        <span class="n">pair_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">n_pairs</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">pair_idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">timeframe_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bar</span><span class="p">()</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.downloader</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Raphael.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>