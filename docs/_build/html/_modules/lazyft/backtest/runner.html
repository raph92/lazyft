
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>lazyft.backtest.runner &#8212; LazyFT 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pyramid.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.backtest.runner</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lazyft.backtest.runner</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Contains logic for running backtests.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">freqtrade.commands</span> <span class="kn">import</span> <span class="n">Arguments</span>
<span class="kn">from</span> <span class="nn">freqtrade.commands.optimize_commands</span> <span class="kn">import</span> <span class="n">setup_optimize_configuration</span>
<span class="kn">from</span> <span class="nn">freqtrade.enums</span> <span class="kn">import</span> <span class="n">RunMode</span>
<span class="kn">from</span> <span class="nn">freqtrade.exceptions</span> <span class="kn">import</span> <span class="n">OperationalException</span>
<span class="kn">from</span> <span class="nn">freqtrade.optimize</span> <span class="kn">import</span> <span class="n">backtesting</span><span class="p">,</span> <span class="n">optimize_reports</span>
<span class="kn">from</span> <span class="nn">lazyft</span> <span class="kn">import</span> <span class="n">downloader</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">parameter_tools</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">strategy</span><span class="p">,</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">lazyft.backtest.commands</span> <span class="kn">import</span> <span class="n">BacktestCommand</span>
<span class="kn">from</span> <span class="nn">lazyft.database</span> <span class="kn">import</span> <span class="n">engine</span>
<span class="kn">from</span> <span class="nn">lazyft.models.backtest</span> <span class="kn">import</span> <span class="n">BacktestReport</span>
<span class="kn">from</span> <span class="nn">lazyft.reports</span> <span class="kn">import</span> <span class="n">get_backtest_repo</span><span class="p">,</span> <span class="n">get_hyperopt_repo</span>
<span class="kn">from</span> <span class="nn">lazyft.runner</span> <span class="kn">import</span> <span class="n">Runner</span>
<span class="kn">from</span> <span class="nn">lazyft.space_handler</span> <span class="kn">import</span> <span class="n">SpaceHandler</span>
<span class="kn">from</span> <span class="nn">lazyft.util</span> <span class="kn">import</span> <span class="n">get_latest_backtest_filename</span><span class="p">,</span> <span class="n">store_backtest_stats</span>
<span class="kn">from</span> <span class="nn">sqlmodel</span> <span class="kn">import</span> <span class="n">Session</span>

<span class="n">logger_exec</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;backtest&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="BacktestMultiRunner"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestMultiRunner">[docs]</a><span class="k">class</span> <span class="nc">BacktestMultiRunner</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commands</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BacktestCommand</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs a queue of BacktestRunners. A runner will be created for each command.</span>

<span class="sd">        :param commands: list of BacktestCommand objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">BacktestRunner</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BacktestRunner</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BacktestRunner</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BacktestMultiRunner.execute"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestMultiRunner.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes all runners in the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runners</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_runner</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">r</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Continuing onto next execution&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Output:</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">output_list</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]))</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Completed with </span><span class="si">{}</span><span class="s1"> errors&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">))</span></div>

<div class="viewcode-block" id="BacktestMultiRunner.get_totals"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestMultiRunner.get_totals">[docs]</a>    <span class="k">def</span> <span class="nf">get_totals</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a DataFrame with all of the performances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">),</span> <span class="s2">&quot;No reports found.&quot;</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="o">**</span><span class="n">r</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">dict</span><span class="p">()}</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span></div>

<div class="viewcode-block" id="BacktestMultiRunner.save"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestMultiRunner.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves all reports to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">]:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">session_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_id</span>
            <span class="n">r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reports</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">BacktestReport</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of all reports.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">report</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">runners</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">report</span><span class="p">]</span>

<div class="viewcode-block" id="BacktestMultiRunner.get_best_run"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestMultiRunner.get_best_run">[docs]</a>    <span class="k">def</span> <span class="nf">get_best_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BacktestReport</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the best run using the score metric.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reports</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">score</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BacktestRunner"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner">[docs]</a><span class="k">class</span> <span class="nc">BacktestRunner</span><span class="p">(</span><span class="n">Runner</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">BacktestCommand</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">load_from_hash</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a backtest using the passed commands.</span>

<span class="sd">        :param command: A BacktestCommand with the arguments to pass to freqtrade</span>
<span class="sd">        :param verbose: If True, will print extra output of the command</span>
<span class="sd">        :param load_from_hash: If True, will load the report from the database if it exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_from_hash</span> <span class="o">=</span> <span class="n">load_from_hash</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">command</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.report_id = self.command.hash</span>
        <span class="c1"># self.command.params.logfile = self.log_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BacktestReport</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hash</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;To help avoid running the same backtest&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tag</span>
                <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy_hash</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">:</span>
                <span class="n">command_string</span> <span class="o">+=</span> <span class="n">util</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span>
                    <span class="n">get_hyperopt_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Could not hash command: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="si">}</span><span class="s1">&#39;</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ensemble</span><span class="p">:</span>
            <span class="n">command_string</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ensemble</span><span class="p">])</span>
        <span class="c1"># logger.debug(&#39;Hashing &quot;{}&quot;&#39;, command_string)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">hash</span><span class="p">(</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Command hash: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>

<div class="viewcode-block" id="BacktestRunner.pre_execute"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.pre_execute">[docs]</a>    <span class="k">def</span> <span class="nf">pre_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">backtesting</span><span class="o">.</span><span class="n">Backtesting</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pre-execution tasks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">get_hyperopt_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">strategy</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;Hyperopt id </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1"> does not match strategy </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">parameter_tools</span><span class="o">.</span><span class="n">set_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parameter_tools</span><span class="o">.</span><span class="n">remove_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># start_backtesting(pargs)</span>
        <span class="c1"># Initialize backtesting object</span>

        <span class="c1"># freqtrade.optimize.backtesting.print = self.log</span>

        <span class="c1"># save copy of strategy</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">:</span>
            <span class="n">strategy</span><span class="o">.</span><span class="n">save_strategy_text_to_database</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check to see if the report with hyperopt id has a strategy hash</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">get_hyperopt_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperopt_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export_backup_strategy</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>

        <span class="c1"># backtesting.logger = test_logger</span>
        <span class="n">optimize_reports</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_spaces</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">download_data</span><span class="p">:</span>
            <span class="n">downloader</span><span class="o">.</span><span class="n">download_data_for_strategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">pargs</span> <span class="o">=</span> <span class="n">Arguments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">get_parsed_arg</span><span class="p">()</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">setup_optimize_configuration</span><span class="p">(</span><span class="n">pargs</span><span class="p">,</span> <span class="n">RunMode</span><span class="o">.</span><span class="n">BACKTEST</span><span class="p">)</span>
        <span class="n">bt</span> <span class="o">=</span> <span class="n">backtesting</span><span class="o">.</span><span class="n">Backtesting</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">config</span><span class="p">[</span><span class="s1">&#39;export&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running command: &quot;freqtrade </span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger_exec</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running command: &quot;freqtrade </span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">command_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Backtesting </span><span class="si">{}</span><span class="s1"> with params id &quot;</span><span class="si">{}</span><span class="s1">&quot; - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span> <span class="ow">or</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">bt</span></div>

<div class="viewcode-block" id="BacktestRunner.execute"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.execute">[docs]</a>    <span class="nd">@logger</span><span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">reraise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes the backtest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_exists</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_hashed</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">backtest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_execute</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">backtest</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">OperationalException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;No data found. Terminating.&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">OperationalException</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">:</span><span class="se">\n</span><span class="s1">Strategy path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">strategy_path</span><span class="si">}</span><span class="se">\n</span><span class="s1">Data path: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># logger.exception(f&#39;Backtest failed: {e}&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result_path</span> <span class="o">=</span> <span class="n">store_backtest_stats</span><span class="p">(</span>
                <span class="n">backtest</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exportfilename&#39;</span><span class="p">],</span> <span class="n">backtest</span><span class="o">.</span><span class="n">results</span>
            <span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_worker</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_finished</span><span class="p">(</span><span class="n">success</span><span class="p">)</span></div>

    <span class="c1"># def execute(self, background=False):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Executes the backtest using the passed command.</span>
    <span class="c1">#</span>
    <span class="c1">#     :param background: If True, will run in background</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if self.hash_exists():</span>
    <span class="c1">#         self.load_hashed()</span>
    <span class="c1">#         return</span>
    <span class="c1">#     self.pre_execute()</span>
    <span class="c1">#     # remove interval from CLI to let strategy handle it</span>
    <span class="c1">#     new_command = copy.copy(self.command)</span>
    <span class="c1">#     new_command.params.interval = &#39;&#39;</span>
    <span class="c1">#     try:</span>
    <span class="c1">#         self.process: sh.RunningCommand = sh.freqtrade(</span>
    <span class="c1">#             new_command.command_string.split(&#39; &#39;),</span>
    <span class="c1">#             _out=lambda log: self.sub_process_log(log, False),</span>
    <span class="c1">#             _err=lambda log: self.sub_process_log(log, False),</span>
    <span class="c1">#             _cwd=str(paths.BASE_DIR),</span>
    <span class="c1">#             _bg=background,</span>
    <span class="c1">#             _done=self.on_finished,</span>
    <span class="c1">#         )</span>
    <span class="c1">#         self.running = True</span>
    <span class="c1">#         self.write_worker.start()</span>
    <span class="c1">#         if not background:</span>
    <span class="c1">#             try:</span>
    <span class="c1">#                 self.process.wait()</span>
    <span class="c1">#             except KeyboardInterrupt:</span>
    <span class="c1">#                 self.process.process.signal_group()</span>
    <span class="c1">#     except sh.ErrorReturnCode as e:</span>
    <span class="c1">#         # logger.error(&#39;Sh returned an error &#39;)</span>
    <span class="c1">#         self.exception = e</span>

<div class="viewcode-block" id="BacktestRunner.on_finished"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.on_finished">[docs]</a>    <span class="k">def</span> <span class="nf">on_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">success</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Elapsed time: </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">parameter_tools</span><span class="o">.</span><span class="n">remove_params_file</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_report</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Backtest </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="si">}</span><span class="s1"> finished successfully&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> backtest failed with errors&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">)</span>
                <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">exception</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">strategy</span><span class="o">.</span><span class="n">delete_temporary_strategy_backup_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_strategy_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="BacktestRunner.hash_exists"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.hash_exists">[docs]</a>    <span class="k">def</span> <span class="nf">hash_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the backtest has a hash and the hash exists in the backtest repo, return True</span>
<span class="sd">        :return: A boolean value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_from_hash</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span> <span class="ow">in</span> <span class="n">get_backtest_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get_hashes</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="c1"># noinspection PyIncorrectDocstring</span>

    <span class="c1"># def on_finished(self, _, success, _2):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Callback when the process is finished.</span>
    <span class="c1">#</span>
    <span class="c1">#     :param success:  True if the process finished successfully</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     logger.info(&#39;Elapsed time: {:.2f}&#39;, time.time() - self.start_time)</span>
    <span class="c1">#     self.running = False</span>
    <span class="c1">#     if not success:</span>
    <span class="c1">#         self.error = True</span>
    <span class="c1">#         logger.error(&#39;{} backtest failed with errors&#39;, self.strategy)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         logger.success(&#39;{} backtest completed successfully&#39;, self.strategy)</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             logger.debug(&#39;Generating report...&#39;)</span>
    <span class="c1">#             self.report = self.generate_report()</span>
    <span class="c1">#             logger.debug(&#39;Report generated&#39;)</span>
    <span class="c1">#         except Exception as e:</span>
    <span class="c1">#             logger.exception(e)</span>
    <span class="c1">#             raise</span>

<div class="viewcode-block" id="BacktestRunner.generate_report"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.generate_report">[docs]</a>    <span class="k">def</span> <span class="nf">generate_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BacktestReport</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the report from the output of the backtest.</span>

<span class="sd">        :return: BacktestReport</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">BacktestReport</span><span class="p">(</span>
            <span class="c1"># _backtest_data=BacktestData(text=self.result_path.read_text()),</span>
            <span class="n">backtest_file_str</span><span class="o">=</span><span class="n">get_latest_backtest_filename</span><span class="p">(),</span>
            <span class="n">hyperopt_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="nb">hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">,</span>
            <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;exchange&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
            <span class="n">pairlist</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">pairs</span><span class="p">,</span>
            <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span>
            <span class="n">strategy_hash</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy_hash</span><span class="p">,</span>
            <span class="n">ensemble</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">as_pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">ensemble</span><span class="p">]),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="BacktestRunner.log"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;For logging purposes. Fills the write_queue&quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="n">logger_exec</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">text</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">log_path</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function returns a path to a log file for a backtest report</span>

<span class="sd">        :return: The path to the log file for the backtest.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">BACKTEST_LOG_PATH</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report_id</span><span class="p">))</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.log&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="BacktestRunner.sub_process_log"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.sub_process_log">[docs]</a>    <span class="k">def</span> <span class="nf">sub_process_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback for the subprocess to log the output.</span>

<span class="sd">        :param text: text to log</span>
<span class="sd">        :param out: True if text is stdout</span>
<span class="sd">        :param error: True if text is stderr</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">logger_exec</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sub_process_log</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span></div>

<div class="viewcode-block" id="BacktestRunner.print_report"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.print_report">[docs]</a>    <span class="k">def</span> <span class="nf">print_report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the backtest report output to the console.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_text</span><span class="p">)</span></div>

    <span class="c1"># noinspection PyProtectedMember</span>
<div class="viewcode-block" id="BacktestRunner.save"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BacktestReport</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the report to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_exists</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping save... backtest already exists in the database&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_text</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skipping save... no report generated&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
            <span class="c1"># session.add(report._backtest_data)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
            <span class="c1"># session.refresh(report._backtest_data)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created report id </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">report</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">paths</span><span class="o">.</span><span class="n">BACKTEST_LOG_PATH</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">report</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.log&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">report_id</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">report</span></div>

<div class="viewcode-block" id="BacktestRunner.performance_df"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.performance_df">[docs]</a>    <span class="k">def</span> <span class="nf">performance_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The function takes the report of the strategy and returns a dataframe with the performance of</span>
<span class="sd">        the strategy</span>
<span class="sd">        :return: A dataframe with the performance of the strategy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No report to export.&#39;</span><span class="p">)</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;strategy&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">performance</span><span class="o">.</span><span class="n">dict</span><span class="p">()}</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">performance</span><span class="p">])</span></div>

<div class="viewcode-block" id="BacktestRunner.load_hashed"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.load_hashed">[docs]</a>    <span class="k">def</span> <span class="nf">load_hashed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        It uses the hash to load the report from the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="n">get_backtest_repo</span><span class="p">()</span><span class="o">.</span><span class="n">get_using_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded report with same hash - </span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash</span><span class="p">)</span></div>

<div class="viewcode-block" id="BacktestRunner.update_spaces"><a class="viewcode-back" href="../../../lazyft.backtest.html#lazyft.backtest.runner.BacktestRunner.update_spaces">[docs]</a>    <span class="k">def</span> <span class="nf">update_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the spaces file of the strategy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating custom spaces...&#39;</span><span class="p">)</span>
        <span class="n">sh</span> <span class="o">=</span> <span class="n">SpaceHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">strategy_path</span> <span class="o">/</span> <span class="n">strategy</span><span class="o">.</span><span class="n">get_file_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strategy</span><span class="p">))</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_spaces</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Enabling all custom spaces&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">set_all_enabled</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">space</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_spaces</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Enabling space: </span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">add_space</span><span class="p">(</span><span class="n">space</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">custom_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Setting space-setting: </span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">sh</span><span class="o">.</span><span class="n">add_setting</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="n">sh</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">LazyFT 0.1.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">lazyft.backtest.runner</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Raphael.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.0.0.
    </div>
  </body>
</html>